
var MongoClient = require('mongodb').MongoClient;
var deferred = require('deferred');

function getNutritionByFoodNames(foodNames) {

	var def = deferred();

	MongoClient.connect('mongodb://localhost/recipeer', function(err, db) {

		if (err) {
			throw err;
		}

		if (!foodNames) {
			return null;
		}

		var query = makeQuery(foodNames);
		console.log(query);
		
		var collection = db.collection('nutrition');
		var cursor = collection.find(query);

		var result = new Array();
		cursor.each (function(err, doc) {
			
			if (doc == null) {
				var jsonResult = JSON.stringify(result);
				def.resolve(jsonResult);
				db.close();
			} else {
				result.push(doc);
			}

		});
	});

	return def.promise;
}


//foodNamesからfindのクエリを作成
function makeQuery(foodNames) {

	var orArray = new Array();
	switch (typeof(foodNames)) {

		case 'string':
			orArray.push({'name': foodNames});
			break

		case 'object':
			for (var i = 0; i < foodNames.length; i++) {
				orArray.push({'name': foodNames[i]});
			}
			break;

		default:
			break;

	}			
	
	var query = {'$or': orArray};
	return query;
}

//外部モジュールにメソッドを公開
exports.getNutritionByFoodNames = getNutritionByFoodNames;
